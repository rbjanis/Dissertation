---
title: "Results"
output: 
    word_document:
      reference_docx: word_template.docx
---
```{r setup, echo = F, include = F}
source(here::here("R/packages.R"))
source(here::here("R/funs_cleaning.R"))
source(here::here("R/funs_descriptives.R"))
source(here::here("R/funs_results.R"))

knitr::opts_chunk$set(echo = F, 
                      fig.width = 8,
                      fig.height = 6,
                      dpi = 300,
                      dev = "png",
                      message = F,
                      warning = F,
                      knitr.table.format = "markdown")
theme_set(theme_bw())
```

```{r load}
# change_data <- readd(change_data)
deter_data <- readd(deter_data)
roc_data_intermediate <- readd(roc_data_intermediate)
roc_data <- readd(roc_data)
change_data <- readd(change_data)

change_models <- readd(change_models)
deter_models <- readd(deter_models)
change_shape <- readd(change_shape)
roc_models <- readd(roc_models)

moderators <- readd(moderators)
alphas <- readd(alphas)
alert_data <- readd(alert_data)
# deter_r2_feedback <- readd(deter_r2_feedback)
# deter_r2_mods <- readd(deter_r2_mods)
# change_r2_feedback <- readd(change_r2_feedback)
# change_R2_mods <- readd(change_R2_mods)
```

A total of `r format_number(NROW(change_data))` clients from `r format_number(n_distinct(change_data$CcmhID))` centers were included in analyses, although some subscales had reduced numbers due to clients not being able to go off track or deteriorate on those subscales. Total clients and centers for each subscale are included in the results table for each model. Of the `r format_number(NROW(change_data))` clients, `r format_number(sum(change_data$feedback == 0))` were in the no feedback condition and `r format_number(sum(change_data$feedback == 1))` were in the feedback condition. Table 1 shows the data reduction process and the number of clients and centers lost at each step. 

```{r sessions}
sessions <- group_by(roc_data, UniqueClientID) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(appt_N)
```

```{r alphas}
# alphas <- alphas %>%
#   column_to_rownames("Subscale") %>%
#   t() %>%
#   as_tibble() %>%
#   mutate(alpha = "Overall alpha", .before = 1)
```

Internal consistencies for CCAPS subscales from data included in the present study were in line with established psychometrics for this scale, with alphas ranging from `r min(alphas$Alpha)` on `r str_replace(alphas$Subscale[which.min(alphas$Alpha)], "_", " ")` and `r max(alphas$Alpha)` on `r alphas$Subscale[which.max(alphas$Alpha)]`. After removing sessions above 20, clients attended from 3 to 20 individual sessions, with a mean of `r round(mean(sessions$appt_N),2)`, a SD of `r round(sd(sessions$appt_N),2)`, a median of `r median(sessions$appt_N)`, and a mode of `r CCMHr::get_mode(sessions$appt_N)`. Clients in the feedback condition had higher starting CCAPS scores on some subscales, consistent with increasing trends in CCAPS scores during the time period the data was collected (CITE HENRY). Clients in the feedback condition also attended .7 more sessions on average, had more frequent CCAPS administrations, and were less likely to have a prior hospitalization. Table 2 compares all moderators by feedback condition, as well as other demographic variables. 

```{r prop-alert}
alerts <- group_by(roc_data, UniqueClientID, feedback) %>% 
  summarize(across(contains("alert"), max, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(across(contains("alert"), function(x) ifelse(!is.finite(x), NA, x)))

alerts_condition <- group_by(alerts, feedback) %>% 
  summarize(across(contains("alert"), function(x) scales::percent(mean(x, na.rm = T), accuracy = .01)))

alerts_overall <- summarize(alerts, across(contains("alert"), function(x) mean(x, na.rm = T))) %>% 
  t() %>% 
  as.data.frame() %>% 
  rename(alert_percent = V1) %>% 
  rownames_to_column("subscale") %>% 
  filter(subscale != "alert_any") %>% 
  mutate(subscale = str_remove(subscale, "_alert"),
         subscale = str_remove(subscale, "34")) 
```
Across both feedback conditions, `r scales::percent(mean(alerts$alert_any), accuracy = .01)` of clients went off track on at least one subscale at some point during treatment, and this was identical across no feedback and feedback conditions. The percentage of clients going off track on each subscale ranged from `r scales::percent(min(alerts_overall$alert_percent), .01)` on the `r alerts_overall$subscale[which.min(alerts_overall$alert_percent)]` to `r scales::percent(max(alerts_overall$alert_percent), .01)` on `r alerts_overall$subscale[which.max(alerts_overall$alert_percent)]`. The proportion of clients going off track on each subscale also did not differ between conditions. Figure 1 shows the proportion of clients going off track at each session for both conditions.  

```{r number-alerts, eval=FALSE, include=FALSE}
number_alerts <- group_by(alert_data, UniqueClientID) %>% 
  select(UniqueClientID, subscale, alert, appt_seq) %>% 
  pivot_wider(names_from = subscale, values_from = alert) %>% 
  summarize(across(Depression34:DI, function(x) sum(x, na.rm = T)))

number_alerts %>% 
  pivot_longer(cols = c(Depression34:DI), names_to = "subscale", values_to = "total_alerts") %>% 
  ggplot(aes(x = total_alerts)) +
  geom_histogram() +
  facet_wrap(~subscale)
```

## Deterioration
```{r deter-ns}
deter_Ns <- map_df(deter_models[1:8], function(x) {data.frame(`Center N` = x[["null"]]@Gp[2], `Client N` = NROW(x[["null"]]@frame))}, .id = "subscale") %>% 
  as_tibble() %>% 
  column_to_rownames("subscale") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column("term")
```

```{r deter-lrts}
deter_LRTs1 <- map_df(deter_models[1:8], function(x) {anova(x[["null"]], x[["feedback"]])}, .id = "subscale")  %>%
  filter(!is.na(Chisq)) %>% 
  mutate(Chisq = round(Chisq, 2),
         Chisq = case_when(`Pr(>Chisq)` < .001 ~ paste0(Chisq, "**"),
                         `Pr(>Chisq)` < .01 ~ paste0(Chisq, "*"),
                         TRUE ~ as.character(Chisq, "**"))) %>%
  select(subscale, Chisq) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("term") %>% 
  mutate(term = "LRT for feedback")
# LRT significant for DI

deter_LRTs2 <- map_df(deter_models[1:8], function(x) {anova(x[["feedback"]], x[["feedback_random"]])}, .id = "subscale")  %>%
  filter(!is.na(Chisq)) %>% 
  mutate(Chisq = round(Chisq, 2),
         Chisq = case_when(`Pr(>Chisq)` < .001 ~ paste0(Chisq, "**"),
                         `Pr(>Chisq)` < .01 ~ paste0(Chisq, "*"),
                         TRUE ~ as.character(Chisq, "**"))) %>%
  select(subscale, Chisq) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("term") %>% 
  mutate(term = "LRT for random effect of feedback")
# No significant random effects

DI_lrt <- anova(deter_models[["DI"]][["null"]], deter_models[["DI"]][["feedback"]])
```

```{r deter-feedback-params}
deter_params_feedback_raw <- suppressWarnings(map_df(deter_models[1:8], function(x) {broom.mixed::tidy(x[["feedback"]])}, .id = "subscale"))

deter_params_feedback <- mutate(deter_params_feedback_raw, estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  select(subscale, term, estimate, SE) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-SE) %>% 
  pivot_wider(names_from = subscale, values_from = estimate) %>% 
  mutate(term = fct_recode(term, Intercept = "(Intercept)",
                           Feedback = "feedback",
                           `Intercept variance` = "sd__(Intercept)")) %>% 
  mutate_all(stringr::str_remove, " \\(NA\\)") %>% 
  rbind(deter_LRTs1) %>% 
  rbind(deter_LRTs2) %>% 
  rbind(deter_Ns) %>% 
  mutate(term = str_replace(term, "\\.", " ")) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
# Significant effect on DI only
```

```{r deter-rates}
deter_rates <- deter_data %>%
  group_by(feedback) %>%
  summarize_at(vars(Depression34_deter:DI_deter), list(function(x) mean(x == 1, na.rm = T))) %>% 
  mutate_at(vars(-feedback), scales::percent, accuracy = .01) %>% 
  mutate(`Feedback Condition` = ifelse(feedback == 1, "Feedback", "No feedback"), .before = 1) %>% 
  select(-feedback) %>% 
  rename_all(~(str_remove(., "_deter"))) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI") %>% 
  as.data.frame()

# Deterioration rates for the sample included
# deter_rates_cut <- map_dfc(c("Depression34", "Anxiety34", "Social_Anxiety34", "Academics34",
#                 "Eating34", "Hostility34", "Alcohol34", "DI"), get_deter_rates) %>% 
#   mutate_all(scales::percent, accuracy = .1) %>% 
#   mutate(feedback = c(0, 1), .before = 1)
```
First, client deterioration on each subscale, or reliable worsening, was examined as an outcome. The direction of the effect on this outcome across all subscales was toward reduced deterioration in the feedback condition; however, the effect of feedback only significantly improved model fit on the DI ($\chi$^2^(1) = `r DI_lrt[2, "Chisq"]`, *p* = `r round(DI_lrt[2, "Pr(>Chisq)"],3)`). The effect was small, however, (`r pull_deter_stats("DI", "feedback")`), and the R^2^ was less than 1%, indicating that this was not a strong effect, with clients in the feedback condition being 10% less likely to deteriorate on the DI. Table 3 shows the effect of feedback on all subscales, and deterioration rates for each subscale by feedback condition are shown in Table 4.  

Addressing research question two, feedback had more of an impact on reducing deterioration on a general index of distress than on any of the domain specific subscales, although the effect was small. Addressing research question three, the random effect of feedback within centers did not significantly improve model fit on any of the subscales, and for several subscales, the inclusion of a random effect of feedback produced boundary estimates for the parameters and near singular fit warnings. This indicates that the effect of feedback on deterioration did not differ by center, and random effects of feedback were not included in subsequent models.   

```{r deter-moderators}
deter_params_mods <- suppressWarnings(map_df(deter_models[1:8], function(x) {broom.mixed::tidy(x[["moderators"]])}, .id = "subscale")) %>%
  mutate(estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  select(subscale, term, estimate, SE) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-SE) %>% 
  pivot_wider(names_from = subscale, values_from = estimate) %>%
  mutate_all(stringr::str_remove, " \\(NA\\)") %>% 
  mutate(term = str_replace(term, ":", "*")) %>% 
  mutate(term = fct_recode(term, Intercept = "(Intercept)",
                           Feedback = "feedback",
                           `Client baseline` = "outcome_first",
                           `Center baseline` = "outcome_first_center",
                           `Client CCAPS frequency` = "ccaps_freq",
                           `Center CCAPS frequency` = "ccaps_freq_center",
                           `Client Appointment N` = "appt_n",
                           `Center Appointment N` = "appt_n_center",
                           Hospitalization = "hospitalization",
                           `Feedback * Client baseline` = "feedback*outcome_first",
                           `Feedback * Center baseline` = "feedback*outcome_first_center",
                           `Feedback * Client CCAPS frequency` = "feedback*ccaps_freq",
                           `Feedback * Client Appointment N` = "feedback*appt_n",
                           `Feedback * Hospitalization` = "feedback*hospitalization",
                           `Feedback * Center CCAPS frequency` = "feedback*ccaps_freq_center",
                           `Feedback * Center Appointment N` = "feedback*appt_n_center",
                           `Intercept variance` = "sd__(Intercept)")) %>% 
  rbind(deter_Ns) %>% 
  mutate(term = str_replace(term, "\\.", " ")) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
```

Finally, interactions were tested between feedback condition and each of the moderator variables. None of the moderators produced a significant effect. Looking at main effects in the absence of significant interactions, client baseline was related to deterioration on all subscales except Eating Concerns and Alcohol Use, such that higher client baseline scores decreased the odds of deterioration. Average center baseline did not have a main effect beyond the effect of client baseline. A higher frequency of CCAPS administrations at the client level was associated with decreased deterioration only on the DI, while a higher number of total appointments at the client level was associated with increased deterioration on all subscales except Alcohol Use. Neither variable had a significant effect at the center level. A history of hospitalizations was associated with increased deterioration on all subscales. Coefficients for moderators and main effects are shown in Table 5.  

## Pre to Post Change 
```{r change-ns}
change_Ns <- map_df(change_models[1:8], function(x) {data.frame(Centers = x[["moderators"]][["dims"]][["ngrps"]][1], Clients = x[["moderators"]][["dims"]][["N"]])}, .id = "subscale") %>% 
  as_tibble() %>% 
  column_to_rownames("subscale") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(term = c("Center N", "Client N"), .before = 1)
```

```{r change-lrts}
change_LRTs1 <- map_df(change_models[1:8], function(x) {anova(x[["null"]], x[["feedback"]])[2,8:9]}, .id = "subscale")  %>%
  mutate(LRT = round(`L.Ratio`, 2),
         LRT = case_when(`p-value` < .001 ~ paste0(LRT, "**"),
                         `p-value` < .01 ~ paste0(LRT, "*"),
                         TRUE ~ as.character(LRT, "**"))) %>%
  select(subscale, LRT) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame() %>%
  mutate(term = "LRT for feedback", .before = 1)
# Feedback improved model fit for academics, hostility, alcohol

change_LRTs2 <- map_df(change_models[1:8], function(x) {anova(x[["feedback"]], x[["feedback_random"]])[2,8:9]}, .id = "subscale")  %>%
  mutate(LRT = round(`L.Ratio`, 2),
         LRT = case_when(`p-value` < .001 ~ paste0(LRT, "**"),
                         `p-value` < .01 ~ paste0(LRT, "*"),
                         TRUE ~ as.character(LRT, "**"))) %>%
  select(subscale, LRT) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame() %>%
  mutate(term = "LRT for random effect of feedback", .before = 1)
# Random effect of feedback for Depression, Anxiety, Social Anxiety, Alcohol, and DI
```

```{r change-feedback-table}
change_params_feedback <- suppressWarnings(map_df(change_models[1:8], function(x) {broom.mixed::tidy(x[["feedback_random"]])}, .id = "subscale")) %>%
  mutate(estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  select(-c(effect, group, statistic, df, `p.value`, `std.error`)) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-SE) %>% 
  pivot_wider(names_from = subscale, values_from = estimate) %>% 
  mutate_all(stringr::str_remove, " \\(NA\\)") %>% 
    mutate(term = fct_recode(term, Intercept = "(Intercept)",
                           Feedback = "feedback",
                           "Intercept variance" = "sd_(Intercept)",
                           Covariance = "cor_feedback.(Intercept)",
                           "Feedback variance" = "sd_feedback",
                           "Residual variance" = "sd_Observation"),
           term = fct_relevel(term, "Intercept", "Feedback", "Intercept variance", "Feedback variance")) %>% 
  arrange(term)
  

change_random <- rbind(map_df(change_models[1:8], function(x) {as.numeric(VarCorr(x[["feedback_random"]])[1])/(as.numeric(VarCorr(x[["feedback_random"]])[1])+ as.numeric(VarCorr(x[["feedback_random"]])[2]) + as.numeric(VarCorr(x[["feedback_random"]])[3]))}, .id = "subscale"),
                       map_df(change_models[1:8], function(x) {as.numeric(VarCorr(x[["feedback_random"]])[2])/(as.numeric(VarCorr(x[["feedback_random"]])[1])+ as.numeric(VarCorr(x[["feedback_random"]])[2]) + as.numeric(VarCorr(x[["feedback_random"]])[3]))}, .id = "subscale")) %>% 
  mutate(across(everything(), scales::percent, accuracy = .1)) %>% 
  mutate(term = c("Center intercept ICC", "Center feedback ICC"), .before = 1)

change_params_feedback <- rbind(change_params_feedback, change_random) %>% 
  rbind(change_LRTs1) %>% 
  rbind(change_LRTs2) %>% 
  rbind(change_Ns) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
```

Next, pre to post treatment change on each subscale was examined as an outcome, with positive change indicating improvement. The addition of feedback condition improved model fit on Academic Distress (`r change_lrts("Academics34")`), Hostility (`r change_lrts("Hostility34")`), and Alcohol Use (`r change_lrts("Alcohol34")`). The coefficients themselves, however, were all 0 and non-significant, with R2 values of less than 1%, indicating that this was not a meaningful effect. Table 6 shows the effect of feedback on each subscale, and Figure 2 shows the predicted amount of CCAPS improvement on each subscale for the two feedback conditions. Given the lack of meaningful effects on any subscale, there is no evidence that the effect of feedback differed by domain.  

Addressing research question three, a center level random effect of feedback was tested. The random effect of feedback significantly improved model fit on models of Depression (`r change_lrts_rand("Depression34")`), Generalized Anxiety (`r change_lrts_rand("Anxiety34")`), Social Anxiety (`r change_lrts_rand("Social_Anxiety34")`), Alcohol Use (`r change_lrts_rand("Alcohol34")`), and the DI (`r change_lrts_rand("DI")`), and random effects of feedback were retained for subsequent models of pre to post change on only those subscales. These random effects indicate the presence of center variation around the overall effect of feedback; however, this effect was small, accounting for less than 1% of the variance, while other differences between centers accounted for 1.2% to 3.1% of the variance on those same subscales. Table 6 shows the random effects variance for all subscales and the percent of variance accounted for. The small random effects variance components indicate that while feedback may have been more effective at some centers than others, it was not a large effect. Understanding differences in how CCAPS feedback is utilized within each center may help explain these small differences. Although outside the scope of this study, the discussion will explore possible center policies and characteristics that may be associated with more positive feedback effects.  

```{r change-moderators}
change_params_fixed_raw <- suppressWarnings(map_df(change_models[1:8], function(x) {broom.mixed::tidy(x[["moderators"]])}, .id = "subscale"))

change_params_fixed <- mutate(change_params_fixed_raw, estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  select(-c(effect, group, statistic, df, `p.value`, `std.error`)) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-SE) %>% 
  pivot_wider(names_from = subscale, values_from = estimate) %>%
  mutate_all(stringr::str_remove, " \\(NA\\)") %>% 
  mutate(term = str_replace(term, ":", "*")) %>% 
  head(-4) %>% 
  mutate(term = fct_recode(term, Intercept = "(Intercept)",
                           Feedback = "feedback",
                           `Off track` = "outcome_alert",
                           `Client baseline` = "outcome_first",
                           `Center baseline` = "outcome_first_center",
                           `Client CCAPS frequency` = "ccaps_freq",
                           `Center CCAPS frequency` = "ccaps_freq_center",
                           `Client Appointment N` = "appt_n",
                           `Center Appointment N` = "appt_n_center",
                           Hospitalization = "hospitalization",
                           `Feedback * Off track` = "feedback*outcome_alert",
                           `Feedback * Client baseline` = "feedback*outcome_first",
                           `Feedback * Center baseline` = "feedback*outcome_first_center",
                           `Feedback * Client CCAPS frequency` = "feedback*ccaps_freq",
                           `Feedback * Client Appointment N` = "feedback*appt_n",
                           `Feedback * Hospitalization` = "feedback*hospitalization",
                           `Feedback * Center CCAPS frequency` = "feedback*ccaps_freq_center",
                           `Feedback * Center Appointment N` = "feedback*appt_n_center",
                           `Feedback * Hospitalization` = "feedback*hospitalization"))

change_params_random <- suppressWarnings(map_df(change_models[1:8], function(x) {broom.mixed::tidy(x[["moderators"]])}, .id = "subscale")) %>% 
  select(-c(effect, group, statistic, df, `p.value`, `std.error`)) %>%
  pivot_wider(names_from = subscale, values_from = estimate) %>%
  tail(4) %>% 
  mutate(term = c("Intercept variance", "Covariance", "Feedback variance", "Residual variance")) %>% 
  mutate(across(is.numeric, function(x) x^2), across(is.numeric, round, 2),
         term = fct_relevel(term, "Intercept variance", "Feedback variance"),
         across(everything(), function(x) replace_na(x, "-"))) %>% 
  arrange(term)
  

change_params_mods <- plyr::rbind.fill(change_params_fixed, change_params_random)

change_params_mods <- rbind(change_params_mods, change_Ns) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
```

Finally, five moderator variables were added to the model to address research question four. Client baseline CCAPS score was a significant moderator on four subscales, although the direction of the effect was not consistent. For Generalized Anxiety (`r pull_change_mods("Anxiety34", "feedback:outcome_first")`) and the Distress Index (`r pull_change_mods("DI", "feedback:outcome_first")`), as baseline CCAPS increased, feedback became less effective. On the other hand, for Hostility (`r pull_change_mods("Hostility34", "feedback:outcome_first")`) and Alcohol Use (`r pull_change_mods("Alcohol34", "feedback:outcome_first")`), as baseline CCAPS increased, feedback became more effective. Center baseline was a significant moderator for Social Anxiety (`r pull_change_mods("Social_Anxiety34", "feedback:outcome_first_center")`), indicating that as the average center baseline level of Social Anxiety increased, feedback became more effective. While significant, these moderators had a small effect, with standardized coefficients of .01-.02 and R^2^ values less than 1%. Other moderators did not have a significant effect.   

There was a strong main effect for going off track on all subscales, and the lack of significant interaction indicates that this effect did not differ by feedback status. Even in the feedback condition where clients who went off track received an off track alert, receiving this alert did not result in returning to an on track trajectory and achieving outcomes similar to clients who did not go off track. Other main effects indicated that, consistent with prior research (CITE DEVER'S PAPER), clients with higher baseline CCAPS achieved more positive change. Diverging from models of deterioration, there were also significant main effects on every subscale for CCAPS frequency and number of appointments at the client level, such that independent of feedback condition, clients with more frequent CCAPS administrations and more appointments achieved more change. Interestingly, the average number of appoitments at the center level had a negative effect on Hostility, such that centers with a higher average number of appointments produced less change on Hostility, while clients within each center that received more appointments achieved more change. Consistent with models of deterioration, clients with prior hospitalizations achieved less change on most subscales. The effects for all moderators and main effects are presented in Table 7.  

## Rate of Change
```{r roc-shape}
shape_anovas <- readd(shape_anovas)  %>%
    rownames_to_column("model") %>%
    separate(col = model, into = c("subscale", "model"), sep = "\\.\\.\\.", extra = "merge", fill = "left") %>%
    mutate(model = stringr::str_remove(model, 'x\\[\\[\\"'),
           model = stringr::str_remove(model, '"\\]\\]'))

best_shape <- shape_anovas %>% group_by(subscale) %>% 
  filter(BIC == min(BIC)) %>% 
  select(subscale, model, BIC) %>% 
  mutate(model = fct_recode(model, "negative reciprocal" = "inverse",
                            "logarithmic" = "loglinear"))

# shape_anovas %>% group_by(subscale) %>% 
#   filter(AIC == min(AIC)) %>% 
#   select(subscale, model, AIC)
# 
# shape_anovas %>% group_by(subscale) %>% 
#   filter(logLik == max(logLik)) %>% 
#   select(subscale, model, logLik)
```

```{r roc-lrts}
roc_LRTs1 <- map_df(roc_models[1:8], function(x) {anova(x[["null"]], x[["feedback"]])}, .id = "subscale")  %>%
  filter(!is.na(Chisq)) %>% 
  mutate(LRT = round(`Chisq`, 2),
         LRT = case_when(`Pr(>Chisq)` < .001 ~ paste0(LRT, "**"),
                         `Pr(>Chisq)` < .01 ~ paste0(LRT, "*"),
                         TRUE ~ as.character(LRT, "**"))) %>%
  select(subscale, LRT) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame() %>%
  mutate(term = "LRT for feedback")

# Significant for Depression, Anxiety, Social Anxiety, Eating, and DI

roc_LRTs2 <- map_df(roc_models[1:8], function(x) {anova(x[["feedback"]], x[["feedback_random"]])}, .id = "subscale")  %>%
  filter(!is.na(Chisq)) %>% 
  mutate(LRT = round(`Chisq`, 2),
         LRT = case_when(`Pr(>Chisq)` < .001 ~ paste0(LRT, "**"),
                         `Pr(>Chisq)` < .01 ~ paste0(LRT, "*"),
                         TRUE ~ as.character(LRT, "**"))) %>%
  select(subscale, LRT) %>%
  as_tibble() %>% 
  column_to_rownames("subscale") %>%
  t() %>%
  as.data.frame()  %>%
  mutate(term = "LRT for random effect of feedback")
# Random effect significant for all but Academics and Eating
```

```{r roc-feedback}
roc_params_feedback_fixed <- suppressWarnings(map_df(roc_models[1:8], function(x) {broom.mixed::tidy(x[["feedback_random"]])}, .id = "subscale")) %>%
  mutate(term = str_remove(term, "log_"),
         term = str_remove(term, "inv_")) %>% 
  mutate(estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-c(effect, group, statistic, `p.value`, `std.error`, SE, df)) %>%
  pivot_wider(names_from = subscale, values_from = estimate) %>% 
  slice(1:4) %>% 
  mutate(term = fct_recode(term, 
                           "Intercept" = "(Intercept)",
                           "Slope" = "appt_seq", 
                           "Slope * Feedback" = "appt_seq:feedback",
                           "Feedback" = "feedback")) %>% 
  as.data.frame()

# None significant

roc_Ns <- map_df(roc_models[1:8], function(x) {data.frame(Centers = n_distinct(x[["null"]]@flist[["CcmhID:UniqueClientID"]]), Clients = n_distinct(x[["null"]]@flist[["CcmhID"]]))}, .id = "subscale") %>% 
  as_tibble() %>% 
  column_to_rownames("subscale") %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(term = c("Center N", "Client N"), .before = 1)

roc_params_feedback_fixed <- rbind(roc_params_feedback_fixed, roc_LRTs1) %>% 
  rbind(roc_LRTs2) %>% 
  rbind(roc_Ns) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
```

Finally, the rate at which CCAPS scores changed during treatment was examined as an outcome. Prior to examining the predictors of interest, different transformations of session number were tested to determine which shape of change provided the best fit for the data. A log transformation provided the best fit on all subscales. The resulting shapes of change can be seen in Figure 3.   

The effect of feedback on rate of change significantly improved model fit on Depression (`r roc_lrts("Depression34")`), Generalized Anxiety (`r roc_lrts("Anxiety34")`), Social Anxiety (`r roc_lrts("Social_Anxiety34")`), Eating Concerns (`r roc_lrts("Eating34")`), and the DI (`r roc_lrts("DI")`). Although model fit was improved, the coefficients for the effect of feedback on slope (represented by the Slope * Feedback coefficients) were not significant, and the standardized coefficients were quite small ($\beta$ = 0 to -.01), indicating that clients in the feedback condition experienced .01 standardized units of CCAPS change more per standardized session than clients in the no feedback condition. The overall effects of slope indicate that clients did improve during treatment on all subscales, and the main effects for feedback indicate that clients in the feedback condition started treatment with slightly higher scores on Depression, Generalized Anxiety, Social Anxiety, and the DI, and slightly lower scores on Hostility and Alcohol Use. Table 8 shows the effect of feedback on each subscale, and Figure 3 shows the predicted trajectories for the two feedback conditions.  

```{r roc_random}
roc_feedback_random <- suppressWarnings(map_df(roc_models[1:8], function(x) {as.data.frame(VarCorr(x[["feedback_random"]]))}, .id = "subscale")) %>% 
  select(subscale, variance = vcov) %>% 
  group_by(subscale) %>% 
  mutate(term = c("Client intercept variance", "Client slope variance", "Client intercept * slope covariance", "Center intercept variance", "Center slope variance", "Center feedback * slope variance", "Center intercept * slope covariance", "Center intercept * slope * feedback covariance", "Center slope * feedback * slope covariance", "Residual")) %>% 
  ungroup() %>% 
  # pivot_longer(cols = -subscale, names_to = "term", values_to = "values") %>% 
  # mutate(term = rep(c("Center Slope", "Slope * Feedback", "Client Slope", "Residual", "Center Slope", "Slope * Feedback", "Client Slope"), 8)) %>% 
  # filter(!is.na(values)) %>% 
  mutate(variance = round(as.numeric(as.character(variance)), 3)) %>% 
  pivot_wider(names_from = subscale, values_from = variance)

roc_var <- function(x, num) {
  as.data.frame(VarCorr(x[["feedback_random"]]))[num, "vcov"]
}

roc_var_sum <- function(x) {
  as.data.frame(VarCorr(x[["feedback_random"]]))[2, "vcov"]+as.data.frame(VarCorr(x[["feedback_random"]]))[5, "vcov"]+as.data.frame(VarCorr(x[["feedback_random"]]))[6, "vcov"]
}

roc_random <- rbind(map_df(roc_models[1:8], function(x) {roc_var(x, 5)/roc_var_sum(x)}, .id = "subscale"),
                       map_df(roc_models[1:8], function(x) {roc_var(x, 6)/roc_var_sum(x)}, .id = "subscale"),
                    map_df(roc_models[1:8], function(x) {roc_var(x, 2)/roc_var_sum(x)}, .id = "subscale")) %>% 
  mutate(across(everything(), scales::percent, accuracy = .1)) %>% 
  mutate(term = c("Center slope ICC", "Feedback slope ICC", "Client slope ICC"), .before = 1)

roc_params_feedback_random <- rbind(roc_feedback_random, roc_random) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI")
```


Addressing research question two, there is no evidence that feedback had a differential effect across domains. Addressing research question three, the random effect of feedback within improved model fit on Depression (`r roc_lrts_rand("Depression34")`), Generalized Anxiety (`r roc_lrts_rand("Anxiety34")`), Social Anxiety (`r roc_lrts_rand("Social_Anxiety34")`), Hostility (`r roc_lrts_rand("Hostility34")`), Alcohol Use (`r roc_lrts_rand("Alcohol34")`), and the DI (`r roc_lrts_rand("DI")`). Although random effects of feedback were retained for these subscales in subsequent models, differences between centers in the effect of feedback on rate of change accounted for less than 1% of the variance on each subscale, while other center effects accounted for 2.2% to 7.0% of the variance in slope, and differences between clients accounted for 90.7% to 97.6% of the variance. Similar to models of pre to post change, this indicates that while there may be differences between centers in the effect of feedback, these differences are small, as are general differences between centers in change trajectories. Random effects variance and ICCs are presented in Table 9.  

```{r roc-moderators}
roc_params_mods_fixed_raw <- suppressWarnings(map_df(roc_models[1:8], function(x) {broom.mixed::tidy(x[["moderators"]])}, .id = "subscale"))

roc_params_mods_fixed <- mutate(roc_params_mods_fixed_raw, term = str_remove(term, "log_")) %>% 
  mutate(estimate = round(estimate, 2)) %>%
  mutate(estimate = ifelse(estimate == "0", "0.00", estimate)) %>%
  mutate(estimate = case_when(`p.value` < .001 ~ paste0(estimate, "**"),
                              `p.value` < .01 ~ paste0(estimate, "*"),
                              TRUE ~ as.character(estimate)),
         estimate = ifelse(estimate == "0", "0.00", estimate),
         SE = as.character(round(`std.error`, 2))) %>%
  mutate(estimate = glue::glue("{estimate} ({SE})")) %>% 
  select(-c(effect, group, statistic, `p.value`, `std.error`, SE, df)) %>%
  pivot_wider(names_from = subscale, values_from = estimate) %>% 
  head(-7) %>%
  mutate(term = str_replace(term, "appt_seq", "Slope"),
         term = str_replace(term, "\\(Intercept\\)", "Intercept"),
         term = str_replace_all(term, ":", " * "),
         term = str_replace(term, "feedback", "Feedback"),
         term = str_replace(term, "outcome_first_center", "Center baseline"),
         term = str_replace(term, "outcome_first", "Client baseline"),
         term = str_replace(term, "outcome_alert", "Off track"),
         term = str_replace(term, "ccaps_freq_center", "Center CCAPS Frequency"),
         term = str_replace(term, "ccaps_freq", "Client CCAPS Frequency"),
         term = str_replace(term, "appt_n_center", "Center Appointment N"),
         term = str_replace(term, "appt_n", "Client Appointment N"),
         term = str_replace(term, "hospitalization", "Hospitalization"),
         term = fct_relevel(term, "Intercept", "Slope", "Feedback", "Slope * Feedback", "Client baseline", "Center baseline", "Off track", "Client CCAPS Frequency", "Center CCAPS Frequency", "Client Appointment N", "Center Appointment N", "Hospitalization", "Feedback * Client baseline", "Feedback * Center baseline", "Feedback * Off track", "Feedback * Client CCAPS Frequency", "Feedback * Center CCAPS Frequency", "Feedback * Client Appointment N", "Feedback * Center Appointment N", "Feedback * Hospitalization", "Slope * Client baseline", "Slope * Center baseline", "Slope * Off track", "Slope * Client CCAPS Frequency", "Slope * Center CCAPS Frequency", "Slope * Client Appointment N", "Slope * Center Appointment N", "Slope * Hospitalization", "Slope * Feedback * Client baseline", "Slope * Feedback * Center baseline", "Slope * Feedback * Off track", "Slope * Feedback * Client CCAPS Frequency", "Slope * Feedback * Center CCAPS Frequency", "Slope * Feedback * Client Appointment N", "Slope * Feedback * Center Appointment N", "Slope * Feedback * sHospitalization")) %>% 
  rename("Depression" = "Depression34", "Generalized Anxiety" = "Anxiety34", "Social Anxiety" = "Social_Anxiety34", "Academic Distress" = "Academics34", "Eating Concerns" = "Eating34", "Hostility" = "Hostility34", "Alcohol Use" = "Alcohol34", "Distress Index" = "DI") %>% 
  arrange(term)
```

Finally, moderator variables were tested as interactions between slope and feedback. After the inclusion of moderator variables, a random effects structure without a random client intercept provided the best fit. Moderators of the effect of feedback on client rate of change are represented by the three way interaction terms (e.g. Slope * Feedback * Client baseline). The effect of client baseline was significant for Hostility (`r pull_roc_mods("Hostility34", "log_appt_seq:feedback:outcome_first")`) and Alcohol use (`r pull_roc_mods("Alcohol34", "log_appt_seq:feedback:outcome_first")`), such that as client baseline increased, the effect of feedback became stronger, resulting in steeper slopes, although the effect was very small, indicating that for clients in the feedback condition a one standardized unit increase in the moderator was associated with an additional .01 standardized unit of CCAPS change per standardized session. Standardized coefficients for all other moderators were 0.  

Looking at main effects of the moderator variables on client rate of change, as client baseline increased, clients experienced more rapid decreases in symptoms across all subscales. Similar to analyses of pre to post change, clients who went off track during treatment exhibited slower recovery trajectories. As CCAPS frequency increased, clients experienced more rapid decreases in symptoms; conversely, as total number of appointments increased, clients experienced slower change, although both effects were small. Finally, hospitalization had a small effect such that clients with prior hospitalizations experienced slower change. Coefficients for all moderators and main effects are presented in Table 10.  

```{r roc-r2, eval=FALSE, include=FALSE}
roc_R2 <- suppressWarnings(map_df(roc_models[1:8], function(x) {r2glmm::r2beta(x[["feedback_random"]], method = "nsj")}, .id = "subscale")) %>%
  select(subscale, Effect, Rsq) %>%
  mutate(Rsq = round(Rsq, 4)) %>%
  pivot_wider(names_from = subscale, values_from = Rsq)

main_effects <- roc_models[["Depression34"]][["feedback_random"]]
moderators <- roc_models[["Depression34"]][["moderators"]]

# save(main_effects, moderators, file = "results/rebecca-dissertation-models.rda")

global_r2 <- MuMIn::r.squaredGLMM(dep_feedback)
r2 <- r2glmm::r2beta(main_effects, method = "sgv")
r2 <- r2glmm::r2beta(main_effects, method = "nsj")

roc_R2 <- suppressWarnings(map_df(roc_models[1:8], function(x) {r2glmm::r2beta(x[["moderators"]], method = "nsj", method = "nsj")}, .id = "subscale")) %>%
  select(subscale, Effect, Rsq) %>%
  mutate(Rsq = round(Rsq, 4)) %>%
  pivot_wider(names_from = subscale, values_from = Rsq)
```

### Table 1  
#### Data Reduction Steps
```{r data-flow-chart}
readd(flow_chart) %>% 
  knitr::kable(format = "pandoc")
```

### Table 2  
#### Demographic and Predictor Variables by Feedback Condition  
```{r moderators}
mods_summary <- roc_data_intermediate %>% 
  group_by(UniqueClientID) %>% 
  slice(1) %>% 
  ungroup() %>% 
  left_join(moderators) %>% 
  CCMHr::sds_to_factor() %>% 
  mutate(feedback = ifelse(feedback == 1, "Feedback", "No feedback"),
         hospitalization = ifelse(hospitalization == 1, "Yes", "No"),
         feedback = fct_relevel(feedback, "No feedback"),
         SDS_01 = ifelse(SDS_01 == "Never", "No", "Yes")) %>% 
  select(feedback, Depression34:DI, hospitalization, appt_N, ccaps_frequency, ClientAge, Gender = SDS_88, SDS_01) 

descriptive_table <- finalfit::summary_factorlist(mods_summary, dependent = "feedback", 
                             explanatory = c("ClientAge", "Gender", "SDS_01", "Depression34", "Anxiety34", "Social_Anxiety34", "Academics34", "Eating34", "Hostility34", "Alcohol34", "DI", "ccaps_frequency", "appt_N", "hospitalization"),
                             p = F,
                             add_col_totals = T,
                             col_totals_rowname = "Total client N (%)",
                             digits = c(2,2,2,2)) %>% 
  mutate(label = str_remove(label, "34"),
         label = fct_recode(label, "Academic Distress" = "Academics", 
                           "Alcohol Use" = "Alcohol",
                           "Eating Concerns" = "Eating",
                           "Generalized Anxiety" = "Anxiety",
                           "Distress Index" = "DI",
                            "Social Anxiety" = "Social_Anxiety",
                            `CCAPS frequency` = "ccaps_frequency",
                           `Appointment N` = "appt_N",
                           Hospitalization = "hospitalization",
                           `Prior therapy` = "SDS_01",
                           `Client age` = "ClientAge",
                           " " = "")) %>% 
  rename("Variable" = label, "Value" = levels)
  
knitr::kable(descriptive_table, format = "markdown")
  
  # TODO: add other demographic variables
```

### Table 3  
#### Effects of Feedback on Deterioration  
```{r table3}
kable(deter_params_feedback, format = "pandoc",
      col.names = c("", names(deter_params_feedback)[2:length(names(deter_params_feedback))]))
```

### Table 4  
#### Deterioration Rates by Subscale
```{r table4}
kable(deter_rates, format = "pandoc")
```

### Table 5  
#### Moderating Effects of Feedback on Deterioration 
```{r table5}
kable(deter_params_mods, format = "pandoc",
      col.names = c("", names(deter_params_mods)[2:length(names(deter_params_mods))]))
```

### Table 6  
#### Effects of Feedback on Pre to Post Treatment Change
```{r table6}
kable(change_params_feedback, format = "pandoc", row.names = F,
      col.names = c("", names(change_params_feedback)[2:length(names(change_params_feedback))]))
```

### Table 7  
#### Moderating Effects of Feedback on Pre to Post Treatment Change
```{r table7}
kable(change_params_mods, format = "pandoc", row.names = F,
      col.names = c("", names(change_params_mods)[2:length(names(change_params_mods))]))
```

### Table 8  
#### Fixed Effects of Feedback on Rate of Change
```{r table8}
kable(roc_params_feedback_fixed, format = "pandoc", row.names = F,
      col.names = c("", names(roc_params_feedback_fixed)[2:length(names(roc_params_feedback_fixed))]))
```

### Table 9
#### Random Effects of Feedback on Rate of Change
```{r}
kable(roc_params_feedback_random, format = "pandoc",
      col.names = c("", names(roc_params_feedback_random)[2:length(names(roc_params_feedback_random))]))
```

### Table 10  
#### Moderating Effects of Feedback on Rate of Change
```{r table9}
kable(roc_params_mods_fixed, format = "pandoc",
      col.names = c("", names(roc_params_mods_fixed)[2:length(names(roc_params_mods_fixed))]))
```

### Figure 1  
#### Proportion of Clients Off Track at Each Session
```{r when-alert}
mutate(alert_data, feedback = ifelse(Date <= "2015-07-01", 0, 1)) %>% 
  group_by(appt_seq, subscale, feedback) %>% 
  summarize(N = n(), alert_n = sum(alert), alert_prop = mean(alert)) %>% 
  ungroup() %>% 
  mutate(subscale = str_remove(subscale, "34"),
         subscale = str_replace(subscale, "_", " "),
         subscale = fct_recode(subscale, "Academic Distress" = "Academics", 
                               "Alcohol Use" = "Alcohol",
                               "Eating Concerns" = "Eating",
                               "Generalized Anxiety" = "Anxiety",
                               "Distress Index" = "DI"),
         subscale = fct_relevel(subscale, "Depression", "Generalized Anxiety", "Social Anxiety", "Academic Distress", "Eating Concerns", "Alcohol Use", "Hostility", "Distress Index")) %>% mutate(feedback = ifelse(feedback == 1, "Enhanced feedback", "Feedback as usual")) %>% 
  ggplot(aes(x = appt_seq, y = alert_prop, group = feedback, color = feedback)) +
  geom_point() +
  geom_line() +
  facet_wrap(~subscale, scales = "free_x") +
  scale_y_continuous(breaks = seq(.04,.16, .02), labels = scales::percent_format(accuracy = 1), limits = c(.04,.16)) +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_color_manual(values = c("#244579FF", "#C6242DFF")) +
  theme_bw() +
  # ggtitle("Proportion of Clients Off Track at Each Session") +
  labs(x = "Appointment Number",
       y = "Proportion of Clients Off Track") +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```

### Figure 2  
#### Predicted CCAPS Change by Feedback Condition
```{r change-plots}
pred_change <- map_df(change_models[1:8], predict_change) %>% 
  mutate(feedback = c("Feedback as usual", "Enhanced feedback"),
         feedback = fct_relevel(feedback, "Feedback as usual")) %>% 
  pivot_longer(Depression34:DI, names_to = "subscale", values_to = "change") %>% 
    mutate(subscale = str_remove(subscale, "34"),
         subscale = str_replace(subscale, "_", " "),
         subscale = fct_recode(subscale, "Academic Distress" = "Academics", 
                               "Alcohol Use" = "Alcohol",
                               "Eating Concerns" = "Eating",
                               "Generalized Anxiety" = "Anxiety",
                               "Distress Index" = "DI"),
         subscale = fct_relevel(subscale, "Depression", "Generalized Anxiety", "Social Anxiety", "Academic Distress", "Eating Concerns", "Alcohol Use", "Hostility", "Distress Index"))

ggplot(pred_change, aes(x = feedback, y = change)) +
  geom_bar(stat = "identity", fill = "#244579FF") +
  geom_label(aes(label = round(change,2)), nudge_y = .085) +
  facet_wrap(~subscale) +
  scale_y_continuous(limits = c(0,.8)) +
  labs(x = "",
       y = "Predicted CCAPS improvement")
```

### Figure 3  
#### Predicted CCAPS Change Trajectories by Feedback Condition 
```{r roc-plots}
pred_roc <- map2_dfc(roc_models[1:8], c("Depression34", "Anxiety34", "Social_Anxiety34", "Academics34",
                "Eating34", "Hostility34", "Alcohol34", "DI"), predict_roc) %>% 
  mutate(feedback = c(rep("Feedback as usual", 20), rep("Enhanced feedback", 20)),
         feedback = fct_relevel(feedback, "Feedback as usual"),
         appointment = rep(seq(1,20), 2)) %>% 
  pivot_longer(Depression34:DI, names_to = "subscale", values_to = "score") %>% 
    mutate(subscale = str_remove(subscale, "34"),
         subscale = str_replace(subscale, "_", " "),
         subscale = fct_recode(subscale, "Academic Distress" = "Academics", 
                               "Alcohol Use" = "Alcohol",
                               "Eating Concerns" = "Eating",
                               "Generalized Anxiety" = "Anxiety",
                               "Distress Index" = "DI"),
         subscale = fct_relevel(subscale, "Depression", "Generalized Anxiety", "Social Anxiety", "Academic Distress", "Eating Concerns", "Alcohol Use", "Hostility", "Distress Index"))

ggplot(pred_roc, aes(x = appointment, y = score, group = feedback, color = feedback)) +
  geom_point() +
  geom_line() +
  facet_wrap(~subscale, scales = "free_x") +
  scale_x_continuous(breaks = seq(0, 20, 5), limits = c(0,20), expand = c(.01,.01)) +
  # scale_y_continuous(limits = c(-1.25, 0), breaks = seq(-1.25, 0, .25)) +
  scale_color_manual(values = c("#244579FF", "#C6242DFF")) +
  labs(x = "Appointment number",
       y = "CCAPS Score") +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))
```
